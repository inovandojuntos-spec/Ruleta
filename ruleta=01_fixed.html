<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ruleta (Audio embebido)</title>

  <style>
    :root{
      --bg:#000000;
      --edge:rgba(255,255,255,.10);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.35);
    }

    html,body{
      height:100%;
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:#000;
      color:var(--text);
    }

    .wrap{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:14px;
      box-sizing:border-box;
    }

    .card{
      width:min(640px,100%);
      background:#000;
      border:1px solid var(--edge);
      border-radius:22px;
      padding:14px;
      box-shadow:0 28px 90px rgba(0,0,0,.9);
      position:relative;
    }

    .logoHeader{
      display:flex;
      justify-content:center;
      align-items:center;
      padding:14px 0 12px;
      margin:-14px -14px 0;
      background:#000;
      border-top-left-radius:22px;
      border-top-right-radius:22px;
    }

    .logoHeader img{
      width:42vw;
      max-width:140px;
      height:auto;
    }

    .stage{
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:14px 0 16px;
      background:#000;
      border-radius:18px;
      margin-top:10px;
    }

    canvas{
      width:min(420px,90vw);
      height:auto;
      aspect-ratio:1/1;
      filter:drop-shadow(0 10px 28px rgba(0,0,0,.9));
    }

    .pin{
      position:absolute;
      top:6px;
      width:0;height:0;
      border-left:14px solid transparent;
      border-right:14px solid transparent;
      border-top:22px solid rgba(255,255,255,.9);
      filter:drop-shadow(0 8px 16px rgba(0,0,0,.9));
    }

    .btnBig{
      width:100%;
      cursor:pointer;
      border:1px solid rgba(255,255,255,.18);
      background:linear-gradient(180deg, rgba(255,255,255,.12) 0%, rgba(255,255,255,.04) 100%);
      color:var(--text);
      padding:18px 14px;
      border-radius:16px;
      font-weight:950;
      letter-spacing:1px;
      font-size:18px;
      text-transform:uppercase;
      box-shadow:0 14px 34px rgba(0,0,0,.75);
      margin-top:12px;
    }
    .btnBig:active{transform:translateY(1px)}
    .btnBig[disabled]{ opacity:.55; cursor:not-allowed; }

    .result{
      margin-top:10px;
      padding:12px 14px;
      border-radius:14px;
      background:linear-gradient(180deg, rgba(255,255,255,.05) 0%, rgba(255,255,255,.02) 100%);
      border:1px solid rgba(255,255,255,.10);
    }
    .result .value{
      font-size:20px;
      font-weight:950;
      letter-spacing:.2px;
      line-height:1.25;
    }

    .playerBox{
      margin-top:12px;
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      overflow:hidden;
      background:#000;
      display:none;
    }

    .playerRow{
      display:flex;
      gap:10px;
      align-items:center;
      padding:10px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }

    .btnSmall{
      cursor:pointer;
      border:1px solid rgba(255,255,255,.18);
      background:linear-gradient(180deg, rgba(255,255,255,.12) 0%, rgba(255,255,255,.04) 100%);
      color:rgba(255,255,255,.92);
      padding:10px 12px;
      border-radius:12px;
      font-weight:900;
      letter-spacing:.6px;
      text-transform:uppercase;
      font-size:12px;
      white-space:nowrap;
    }
    .btnSmall:active{ transform: translateY(1px); }

    .playerHint{
      color:rgba(255,255,255,.55);
      font-size:12px;
      line-height:1.2;
    }

    .audioNative{
      width:100%;
      display:block;
      background:#000;
      filter:invert(1) hue-rotate(180deg) saturate(0.2);
      opacity:.95;
    }

    .toast{
      margin:10px 10px 0;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      color:rgba(255,255,255,.70);
      font-size:12px;
      display:none;
    }
    .toast.show{ display:block; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">

      <div class="logoHeader">
        <img src="images/logo.png" alt="Innovando Juntos">
      </div>

      <div class="stage">
        <div class="pin"></div>
        <canvas id="wheel" width="800" height="800"></canvas>
      </div>

      <button class="btnBig" id="btnSpin">GIRAR</button>

      <div class="result" role="status" aria-live="polite">
        <div class="value" id="resultText">—</div>
      </div>

      <div class="playerBox">
        <div class="playerRow">
          <button class="btnSmall" id="btnPlay">▶ PLAY</button>
          <div class="playerHint" id="playerHint">
            En celular, el audio requiere un toque del usuario.
          </div>
        </div>

        <div id="toast" class="toast">Si no se reproduce automáticamente, toca ▶ PLAY.</div>

        <audio id="audio" class="audioNative" controls preload="none">
          <source id="audioSrc" src="audios/pregunta.mp3" type="audio/mpeg">
          Tu navegador no soporta audio HTML5.
        </audio>
      </div>

    </div>
  </div>

<script>
// =========================
// CONFIG DESDE JSON
// =========================
const CONFIG_URL = "preguntas/questions.json";
const SUPABASE_ANON_KEY = "sb_publishable_iA35OOvF4WVTKJ4d7G0W7A_TR4FLwf9";

// =========================
// SUPABASE EDGE FUNCTION
// =========================
const SNAPSHOT_ENDPOINT = "https://rsordtljnvxonaygyuxd.supabase.co/functions/v1/snapshot";
const SNAPSHOT_KEY = "sb_publishable_iA35OOvF4WVTKJ4d7G0W7A_TR4FLwf9";


function uuid(){
  return (crypto.randomUUID
    ? crypto.randomUUID()
    : String(Date.now()) + "-" + Math.random().toString(16).slice(2)
  );
}

function safeJSONParse(s){
  try { return JSON.parse(s); } catch { return null; }
}
function nowISO(){ return new Date().toISOString(); }

const PROFILE_KEY  = "player_profile";

function getProfile(){
  return safeJSONParse(localStorage.getItem(PROFILE_KEY));
}


function getOrCreateSnapshotBase(){
  let snap = safeJSONParse(localStorage.getItem(SNAPSHOT_KEY));
  if (!snap || !snap.player_id || !snap.session_id){
    snap = {
      player_id: uuid(),
      session_id: uuid(),
      profile_name: null,
      profile_contact: null,
      games_total: 0,
      spins_session: 0,
      total_time_ms: 0,
      last_group: null,
      last_question: null,
      last_result_text: null,
      counts_by_group: {},
      created_at: nowISO(),
      updated_at: nowISO(),
      session_started_at_ms: performance.now(),
      last_saved_at_ms: performance.now(),
      last_save_trigger: "created_on_ruleta"
    };
    localStorage.setItem(SNAPSHOT_KEY, JSON.stringify(snap));
  }

  // compatibiliza con perfil guardado en index.html
  const profile = getProfile();
  if (profile){
    if (profile.player_id) snap.player_id = profile.player_id;
    snap.profile_name = profile.name || snap.profile_name || null;
    snap.profile_contact = profile.contact || snap.profile_contact || null;
    snap.updated_at = nowISO();
    localStorage.setItem(SNAPSHOT_KEY, JSON.stringify(snap));
  }

  return snap;
}

async function postSnapshotToSupabase(payload){
  try{
    const res = await fetch(SNAPSHOT_ENDPOINT, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "apikey": SUPABASE_ANON_KEY,
        "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
      },
      body: JSON.stringify(payload),
    });

    if (!res.ok){
      const txt = await res.text();
      console.error("snapshot post failed:", res.status, txt);
      return false;
    }
    return true;

  } catch(e){
    console.error("snapshot post error:", e);
    return false;
  }
}


// =========================
// DATA
// =========================
let QUESTIONS = [];
let GROUPS = [];
let QUESTIONS_BY_GROUP = {};

// =========================
// AUDIO EMBEBIDO
// =========================
const audioEl   = document.getElementById("audio");
const audioSrc  = document.getElementById("audioSrc");
const btnPlay   = document.getElementById("btnPlay");
const toast     = document.getElementById("toast");
const playerBox = document.querySelector(".playerBox");

let audioUnlocked = false;
let FALLBACK_AUDIO = "audios/pregunta.mp3";
let currentAudioUrl = FALLBACK_AUDIO;

function setAudio(url){
  const u = (url && String(url).trim()) ? String(url).trim() : FALLBACK_AUDIO;
  currentAudioUrl = u;
}

async function unlockAudioOnce(){
  if (audioUnlocked) return;

  // Importante: en algunos navegadores (Safari/iOS) es más confiable setear audioEl.src
  // que sólo cambiar el <source>.
  audioEl.pause();
  audioEl.currentTime = 0;

  if (audioSrc) audioSrc.setAttribute("src", currentAudioUrl);
  audioEl.src = currentAudioUrl;
  audioEl.load();

  try{
    // Se hace play/pause dentro del gesto del usuario (click) para "desbloquear" audio.
    await audioEl.play();
    audioEl.pause();
    audioEl.currentTime = 0;
    audioUnlocked = true;
  } catch(e){
    console.log("unlock blocked:", e);
  }
}

async function playMainAudio(url){
  if (url) setAudio(url);

  playerBox.style.display = "block";

  // Forzamos el src correcto siempre (evita que se quede pegado en el default)
  const current = (audioEl.getAttribute("src") || audioEl.src || "");
  if (!current || !current.includes(currentAudioUrl)){
    if (audioSrc) audioSrc.setAttribute("src", currentAudioUrl);
    audioEl.src = currentAudioUrl;
    audioEl.load();
  }

  try{
    toast.classList.remove("show");
    await audioEl.play();
    btnPlay.textContent = "⏸ PAUSE";
  } catch(e){
    console.log("play blocked:", e);
    toast.classList.add("show");
    btnPlay.textContent = "▶ PLAY";
  }
}

function pauseAudio(){
  audioEl.pause();
  btnPlay.textContent = "▶ PLAY";
}

btnPlay.addEventListener("click", async () => {
  if (audioEl.paused){
    await playMainAudio();
  } else {
    pauseAudio();
  }
});

audioEl.addEventListener("ended", () => {
  btnPlay.textContent = "▶ PLAY";
});

// =========================
// TICK SOUND (WebAudio)
// =========================
let audioCtx = null;

function ensureAudioCtx(){
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if (audioCtx.state === "suspended") audioCtx.resume();
}

function playTick(intensity = 1){
  if (!audioCtx) return;
  const t = audioCtx.currentTime;

  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();

  osc.type = "square";
  osc.frequency.setValueAtTime(900 + 250 * intensity, t);

  gain.gain.setValueAtTime(0.0001, t);
  gain.gain.exponentialRampToValueAtTime(0.12 * intensity, t + 0.002);
  gain.gain.exponentialRampToValueAtTime(0.0001, t + 0.03);

  osc.connect(gain);
  gain.connect(audioCtx.destination);

  osc.start(t);
  osc.stop(t + 0.04);
}

// =========================
// CANVAS WHEEL
// =========================
const canvas = document.getElementById("wheel");
const ctx = canvas.getContext("2d");
const cx = 400, cy = 400, R = 350;

let rot = 0, spinning = false;

const TWO_PI = Math.PI * 2;
let slice = TWO_PI / 5;

function drawWheel(rot=0){
  ctx.clearRect(0,0,800,800);

  slice = (Math.PI*2)/GROUPS.length;

  for(let i=0;i<GROUPS.length;i++){
    const a0 = rot + i*slice;
    const a1 = a0 + slice;

    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.arc(cx,cy,R,a0,a1);
    ctx.closePath();
    ctx.fillStyle = i%2 ? "rgba(255,255,255,.06)" : "rgba(255,255,255,.10)";
    ctx.fill();
    ctx.strokeStyle="rgba(255,255,255,.14)";
    ctx.lineWidth=3;
    ctx.stroke();

    ctx.save();
    ctx.translate(cx,cy);
    ctx.rotate(a0 + slice/2);
    ctx.textAlign="right";
    ctx.fillStyle="#fff";
    ctx.font="900 26px system-ui";
    ctx.fillText(GROUPS[i], R-26, 10);
    ctx.restore();
  }
}

function norm(x){
  x = x % TWO_PI;
  return x < 0 ? x + TWO_PI : x;
}

function pickRandomQuestionByGroup(group){
  const arr = QUESTIONS_BY_GROUP[group] || [];
  if (!arr.length) return null;
  return arr[Math.floor(Math.random() * arr.length)];
}

async function spin(){
  if(spinning) return;
  spinning = true;

  document.getElementById("resultText").textContent = "—";
  const btnSpin = document.getElementById("btnSpin");
  btnSpin.disabled = true;

  ensureAudioCtx();

  setAudio(FALLBACK_AUDIO);
  await unlockAudioOnce();

  const start = rot;
  const end = start + (Math.random()*4 + 7) * TWO_PI;
  const t0 = performance.now();

  function anim(t){
    const p = Math.min(1, (t - t0) / 3200);
    const prevRot = rot;

    rot = start + (end - start) * (1 - Math.pow(1 - p, 3));
    drawWheel(rot);

    const aPrev = norm(prevRot);
    const aNow  = norm(rot);

    const segPrev = Math.floor(aPrev / slice);
    const segNow  = Math.floor(aNow  / slice);

    if (segNow !== segPrev) {
      const vel = Math.abs(aNow - aPrev);
      const intensity = Math.min(1, Math.max(0.35, vel / 0.25));
      playTick(intensity);
    }

    if(p < 1){
      requestAnimationFrame(anim);
    } else {
      const idx = Math.floor(((Math.PI*1.5 - rot) % TWO_PI + TWO_PI) / slice);
      const group = GROUPS[idx];

      const q = pickRandomQuestionByGroup(group);

      if (q){
        document.getElementById("resultText").textContent = q.pregunta;
        setAudio(q.audio || "audios/pregunta.mp3");
        playMainAudio(q.audio || "audios/pregunta.mp3");
      } else {
        document.getElementById("resultText").textContent = "(sin preguntas cargadas)";
      }

      // SNAPSHOT
      const snap = getOrCreateSnapshotBase();

      snap.spins_session = (snap.spins_session || 0) + 1;
      snap.games_total   = (snap.games_total || 0) + 1;

      const elapsedMs = Math.max(0, performance.now() - t0);
      snap.total_time_ms = (snap.total_time_ms || 0) + Math.round(elapsedMs);

      snap.last_group = group || null;
      snap.last_question = q ? Number(q.no) : null;
      snap.last_result_text = "Correcto";
      snap.counts_by_group = snap.counts_by_group || {};
      if (group){
        snap.counts_by_group[group] = (snap.counts_by_group[group] || 0) + 1;
      }

      snap.updated_at = nowISO();
      snap.last_saved_at_ms = performance.now();
      snap.last_save_trigger = "spin_completed";

      localStorage.setItem(SNAPSHOT_KEY, JSON.stringify(snap));

      postSnapshotToSupabase({
        player_id: snap.player_id,
        session_id: snap.session_id,
        profile_name: snap.profile_name || null,
        profile_contact: snap.profile_contact || null,
        games_total: snap.games_total,
        spins_session: snap.spins_session,
        total_time_ms: snap.total_time_ms,
        last_group: snap.last_group,
        last_question: snap.last_question,
        last_result_text: snap.last_result_text,
        counts_by_group: snap.counts_by_group
      });

      playTick(1);

      spinning = false;
      btnSpin.disabled = false;
    }
  }

  requestAnimationFrame(anim);
}

// =========================
// CARGA JSON + INIT
// =========================
async function loadConfig(){
  const res = await fetch(CONFIG_URL, { cache: "no-store" });
  if (!res.ok) throw new Error("No se pudo cargar " + CONFIG_URL);
  const cfg = await res.json();

  FALLBACK_AUDIO = (cfg.defaultAudio && String(cfg.defaultAudio).trim()) ? String(cfg.defaultAudio).trim() : FALLBACK_AUDIO;

  QUESTIONS = Array.isArray(cfg.questions) ? cfg.questions : [];

  const fallbackAudio = FALLBACK_AUDIO;
  QUESTIONS = QUESTIONS.map(q => ({
    no: Number(q.no),
    categoria: String(q.categoria || "").trim(),
    pregunta: String(q.pregunta || "").trim(),
    audio: (q.audio && String(q.audio).trim()) ? String(q.audio).trim() : fallbackAudio
  }));

  QUESTIONS_BY_GROUP = {};
  for (const q of QUESTIONS){
    if (!q.categoria) continue;
    if (!QUESTIONS_BY_GROUP[q.categoria]) QUESTIONS_BY_GROUP[q.categoria] = [];
    QUESTIONS_BY_GROUP[q.categoria].push(q);
  }

  GROUPS = Object.keys(QUESTIONS_BY_GROUP);

  if (!GROUPS.length){
    GROUPS = ["MEMÓRIAS","EMOÇÕES","DESEJO","DIÁLOGO","FUTURO"];
    QUESTIONS_BY_GROUP = {
      "MEMÓRIAS": [], "EMOÇÕES": [], "DESEJO": [], "DIÁLOGO": [], "FUTURO": []
    };
  }

  setAudio(FALLBACK_AUDIO);
  drawWheel();
  document.getElementById("btnSpin").addEventListener("click", spin);
}

loadConfig().catch(err => {
  console.log(err);
  GROUPS = ["MEMÓRIAS","EMOÇÕES","DESEJO","DIÁLOGO","FUTURO"];
  QUESTIONS_BY_GROUP = { "MEMÓRIAS": [], "EMOÇÕES": [], "DESEJO": [], "DIÁLOGO": [], "FUTURO": [] };
  setAudio(FALLBACK_AUDIO);
  drawWheel();
  document.getElementById("btnSpin").addEventListener("click", spin);
});
</script>

</body>
</html>
